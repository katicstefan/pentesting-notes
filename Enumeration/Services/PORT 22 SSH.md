# SSH

#### Generate SSH Key pair

```shell
ssh-keygen -t rsa -b 2048 -C "username@hostname"
```

#### Sign the SSH Key with CA

```shell
-s ~/.ssh/ca: Path to your CA private key.
-I key_id: Key ID, a unique identifier for the key (e.g., the username or a meaningful identifier).
-n user: Principal (e.g., the username or set of usernames).
-V +52w: Validity period for the certificate (e.g., 52 weeks).
~/.ssh/id_rsa.pub: The public key you are signing.
```

In the context of SSH certificates, the principal refers to the identity or set of identities that the SSH certificate is associated with.
It essentially specifies which users or hosts the certificate is valid for.

```shell
ssh-keygen -s /etc/ssh/ca -I key_id -n principal -V +52w ./key.pub
```

This command will produce a signed certificate file, `key-cert.pub`.

#### Check if SSH Server Trusts the CA

```shell
cat /etc/ssh/sshd_config
```

#### SSH with private key, signed private key (CA pubkey), pubkey auth, and custom port

```shell
ssh -i privkey -o PreferredAuthentications=publickey -o CertificateFile=privkey-cert.pub -p 2222 username@host
```

#### SCP download with private key, signed private key (CA pubkey), pubkey auth, and custom port

```shell
scp -i privkey -o PreferredAuthentications=publickey -o CertificateFile=privkey-cert.pub -P 2222 username@host:/path/to/file.txt /path/to/file.txt
```

#### SCP basic download

```shell
scp username@hostname:/path/to/file.txt .
```
#### SCP folder/directory download

```shell
scp -r username@hostname:/path/to/directory/ .
```

#### SSH Port Forward

```shell
ssh -L local_port:127.0.0.1:remote_port username@ssh_server_hostname
```

#### Obtain SSH access to machine after getting user shell

1. **Generate the SSH Key Pair:** On the machine where you have the `username` user access, run:
	`ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa`
    Press Enter when prompted to save the key to the default location (`~/.ssh/id_rsa`) and leave the passphrase empty (or set one if you prefer).
    
2. **Add the Public Key to `authorized_keys`:** After generating the key pair, you need to add the public key to the `authorized_keys` file:
    `cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys`
    
    Ensure the permissions are correct:
    `chmod 600 ~/.ssh/authorized_keys`
    `chmod 700 ~/.ssh`
    
3. **Transfer the Private Key:** You can then copy the `id_rsa` file to your local machine to use for SSH login. You might want to cat the file and copy it over SSH or use a tool like `scp` (if possible).
   
4. **SSH Into the Machine:** On your local machine, use the private key to SSH into the HTB machine:
	`ssh -i /path/to/id_rsa username@target_ip`

